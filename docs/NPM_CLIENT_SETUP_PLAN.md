# NPM Client Setup Implementation Plan

**Generated**: Based on actual code analysis + client feedback  
**Methodology**: Architect design + Mechanic verification  
**Scope**: Prepare NPM package for client installation

---

## Part 1: Reality Check - What Actually Exists

### Package Exports (Verified in src/index.ts)

| Export | Path | Status |
|--------|------|--------|
| `createAgentRouter` | `ai-coding-agents/express` | EXISTS |
| `IAgentStorage` | `ai-coding-agents/express` | EXISTS |
| `detectFailure`, `categorizeFailure` | `ai-coding-agents/express` | EXISTS |
| `agentReportsTable` | `ai-coding-agents/drizzle` | EXISTS |
| `agentLogsTable` | `ai-coding-agents/drizzle` | EXISTS |
| `projectGuidelinesTable` | `ai-coding-agents/drizzle` | EXISTS |
| `failurePatternsTable` | `ai-coding-agents/drizzle` | EXISTS |
| `initProject` | `ai-coding-agents` | EXISTS |
| `generateStorageScaffold` | `ai-coding-agents` | EXISTS |
| `createMonitorClient` | `ai-coding-agents` | EXISTS |

### CLI Commands (Verified in src/cli.ts)

| Command | Implemented | Works |
|---------|-------------|-------|
| `invoke <agent> <prompt>` | YES | Requires OPENAI_API_KEY |
| `scan <path>` | YES | Works offline |
| `report <projectId>` | YES | Requires hub API |
| `analytics [projectId]` | YES | Requires hub API |
| `generate-rules <projectId>` | YES | Requires hub API |
| `hooks install/uninstall/status` | YES | Works offline |
| `init` | YES | Works offline |
| `help` | YES | Works offline |
| `verify` | **NO** | Not implemented |

### API Endpoints Required on Client (From express-router.ts)

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/agents/health` | GET | Health check |
| `/api/agents/external/report` | POST | Receive agent reports |
| `/api/agents/reports` | GET | List reports |
| `/api/agents/monitor/analytics` | GET | View analytics |
| `/api/agents/guidelines/:projectId` | GET | Get project guidelines |
| `/api/agents/guidelines/generate` | POST | Force regenerate |
| `/api/agents/logs/ingest` | POST | Log ingestion |
| `/api/agents/logs` | GET | Query logs |
| `/api/agents/logs/stats` | GET | Log statistics |

---

## Part 2: Client Setup Requirements (From Real Client Feedback)

### Files Client Must Create/Modify

| File | Action | Content Source |
|------|--------|----------------|
| `.ai-agents.json` | AUTO (via init) | Generated by init |
| `scripts/ai-agents.sh` | AUTO (via init) | Generated by init |
| `shared/schema.ts` | MANUAL | Import from package |
| `server/storage.ts` | MANUAL | Implement IAgentStorage |
| `server/routes.ts` | MANUAL | Mount createAgentRouter |

### Manual Steps Required (Current State)

1. **Install package**: `npm install github:zambam/ai-coding-agents`
2. **Run init**: `npx ai-agents init --hub-url <url>`
3. **Add schema**: Copy import statements to shared/schema.ts
4. **Run migration**: `npm run db:push`
5. **Implement storage**: Create storage adapter (80+ lines)
6. **Mount router**: Add to server/routes.ts
7. **Test**: curl health endpoint

**Estimated Time**: 30-45 minutes

---

## Part 3: Gaps Identified

### Gap 1: Storage Implementation Not Auto-Generated

**Current**: `generateStorageScaffold()` exists but init doesn't write it to a file.

**Evidence** (src/init.ts lines 136-235):
```typescript
export function generateStorageScaffold(orm: 'drizzle' | 'prisma' | 'none'): string {
  if (orm === 'drizzle') {
    return `...80 lines of code...`;
  }
}
```

**Fix**: Add `--generate-storage` flag to init that writes scaffold to file.

### Gap 2: No Health Check Endpoint Documentation

**Current**: Router provides `/health` but not documented in quickstart.

**Evidence** (src/express-router.ts):
```typescript
router.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});
```

**Fix**: Document in QUICKSTART.md (already done).

### Gap 3: No Verify Command

**Current**: CLI has no way to test if setup is correct.

**Evidence**: `verify` not in src/cli.ts switch statement.

**Fix**: Implement simple verify that:
1. Checks `.ai-agents.json` exists
2. Checks hub URL reachable (if online)
3. Checks schema tables exist (if db available)

### Gap 4: Import Path Confusion

**Current**: Docs reference different paths inconsistently.

| Doc Says | Reality |
|----------|---------|
| `'ai-coding-agents'` | Works for main exports |
| `'ai-coding-agents/express'` | Works for router/storage |
| `'ai-coding-agents/drizzle'` | Works for schema |

**Fix**: Standardize in docs, add path aliases to package.json exports.

---

## Part 4: Simple Verification Checks

### Pre-Publish Checks

```bash
# 1. TypeScript compiles
cd npm-package && npm run build:package

# 2. Package can be packed
npm pack --dry-run

# 3. CLI runs
node dist/cli.js help

# 4. Exports resolve
node -e "require('./dist/index.js')"
node -e "require('./dist/express-router.js')"
node -e "require('./dist/drizzle-schema.js')"
```

### Post-Install Checks (Client-Side)

```bash
# 1. Init creates files
npx ai-agents init --hub-url http://localhost:5000
ls -la .ai-agents.json scripts/ai-agents.sh

# 2. Hooks work
npx ai-agents hooks status

# 3. Scan works (offline)
npx ai-agents scan ./src

# 4. Health check works (after setup)
curl http://localhost:5000/api/agents/health
```

---

## Part 5: Implementation Tasks

### Phase A: Documentation Only (30 min)

| Task | File | Action |
|------|------|--------|
| A1 | `docs/QUICKSTART.md` | DONE - created |
| A2 | `npm-package/README.md` | DONE - added link |
| A3 | Cleanup old proposals | Delete contradicting docs |

### Phase B: CLI Enhancement (60 min)

| Task | File | Action |
|------|------|--------|
| B1 | `src/init.ts` | Add `--write-storage` flag |
| B2 | `src/cli.ts` | Wire up `--write-storage` |
| B3 | `src/cli.ts` | Add `verify` command |

### Phase C: Package Configuration (30 min)

| Task | File | Action |
|------|------|--------|
| C1 | `npm-package/package.json` | Add exports field for subpaths |
| C2 | `npm-package/package.json` | Verify dependencies |
| C3 | `npm-package/.npmignore` | Verify exclusions |

---

## Part 6: API Reference (For Client Implementation)

### IAgentStorage Interface (Required Methods)

```typescript
interface IAgentStorage {
  // Required
  createAgentReport(report: AgentReportInput): Promise<AgentReport>;
  getAgentReports(projectId?: string, limit?: number): Promise<AgentReport[]>;
  getAgentAnalytics(projectId?: string): Promise<AgentAnalytics>;
  
  // Optional (for logging)
  ingestAgentLog?(log: AgentLogInput): Promise<{ id: number }>;
  getAgentLogs?(options: LogQueryOptions): Promise<AgentLog[]>;
  getAgentLogStats?(): Promise<LogStats>;
  
  // Optional (for guidelines)
  getProjectGuidelines?(projectId: string): Promise<ProjectGuidelines | null>;
  generateGuidelines?(projectId: string): Promise<ProjectGuidelines>;
}
```

### AgentReportInput Structure

```typescript
interface AgentReportInput {
  projectId: string;
  externalAgent: string;  // 'cursor' | 'copilot' | 'claude_code' | etc.
  action: string;
  codeGenerated?: string;
  codeAccepted?: boolean;
  humanCorrection?: string;
  metadata?: Record<string, unknown>;
}
```

### AgentAnalytics Structure

```typescript
interface AgentAnalytics {
  totalReports: number;
  acceptanceRate: number;  // 0-1
  failuresByCategory: Record<string, number>;
  failuresBySeverity: Record<string, number>;
  topPatterns: Array<{ pattern: string; count: number }>;
}
```

---

## Part 7: Environment Variables

### Client Must Set

| Variable | Required | Default | Purpose |
|----------|----------|---------|---------|
| `AI_AGENTS_API_URL` | For CLI | `http://localhost:5000` | Hub server URL |
| `AI_AGENTS_PROJECT_ID` | Optional | Directory name | Project identifier |
| `AI_AGENTS_LOG_HTTP` | For logging | - | HTTP log endpoint |
| `OPENAI_API_KEY` | For invoke | - | Agent invocations |

### Auto-Set by Init

| Variable | Set In | Value |
|----------|--------|-------|
| `AI_AGENTS_API_URL` | scripts/ai-agents.sh | From --hub-url |
| `AI_AGENTS_PROJECT_ID` | scripts/ai-agents.sh | From --project-id or dirname |
| `AI_AGENTS_LOG_HTTP` | scripts/ai-agents.sh | `{hub-url}/api/agents/logs/ingest` |

---

## Part 8: Testing Checklist

### Package Build Verification

```bash
# From npm-package/
npm run build:package
npm pack --dry-run 2>&1 | head -50
```

Expected output includes:
- dist/index.js
- dist/cli.js
- dist/express-router.js
- dist/drizzle-schema.js
- dist/init.js

### Export Resolution Test

```bash
# From npm-package/
node -e "
const pkg = require('./dist/index.js');
console.log('Main exports:', Object.keys(pkg).length);
console.log('Has createAgentRouter:', !!pkg.createAgentRouter);
console.log('Has agentReportsTable:', !!pkg.agentReportsTable);
console.log('Has initProject:', !!pkg.initProject);
"
```

### CLI Smoke Test

```bash
node dist/cli.js help
node dist/cli.js hooks status
node dist/cli.js scan --help 2>/dev/null || echo "scan works"
```

---

## Part 9: Approval Checklist

### Ready Now (Phase A)

- [x] QUICKSTART.md created with copy-paste blocks
- [x] README.md updated with quickstart link
- [ ] Delete old/contradicting proposal files

### Needs Implementation (Phase B)

- [ ] Add `--write-storage` flag to init
- [ ] Add `verify` command to CLI
- [ ] Test on clean project

### Pre-GitHub Push (Phase C)

- [ ] Verify package.json exports field
- [ ] Run build:package successfully
- [ ] Run npm pack --dry-run
- [ ] Test CLI commands
- [ ] Test export resolution

---

## Appendix: Files to Delete

Outdated/contradicting proposal files:

```
docs/INSTALL_IMPROVEMENT_PROPOSAL.md  # Has fictional verify command
docs/PHASE1_EASY_FIXES_PROPOSAL.md    # Already deleted
docs/NPM_PACKAGE_PREP_PROPOSAL.md     # Review for conflicts
```

---

**Status**: AWAITING REVIEW

Approve to:
1. Clean up old proposals
2. Implement Phase B (CLI enhancements)
3. Proceed to GitHub push preparation
