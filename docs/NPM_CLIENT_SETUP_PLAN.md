# NPM Client Setup Implementation Plan

**Generated**: Based on actual code analysis + client feedback  
**Methodology**: Architect design + Mechanic verification  
**Scope**: Prepare NPM package for client installation

---

## Part 1: Reality Check - What Actually Exists

### Package Exports (Verified in src/index.ts)

| Export | Path | Status |
|--------|------|--------|
| `createAgentRouter` | `ai-coding-agents/express` | EXISTS |
| `IAgentStorage` | `ai-coding-agents/express` | EXISTS |
| `detectFailure`, `categorizeFailure` | `ai-coding-agents/express` | EXISTS |
| `agentReportsTable` | `ai-coding-agents/drizzle` | EXISTS |
| `agentLogsTable` | `ai-coding-agents/drizzle` | EXISTS |
| `projectGuidelinesTable` | `ai-coding-agents/drizzle` | EXISTS |
| `failurePatternsTable` | `ai-coding-agents/drizzle` | EXISTS |
| `initProject` | `ai-coding-agents` | EXISTS |
| `generateStorageScaffold` | `ai-coding-agents` | EXISTS |
| `createMonitorClient` | `ai-coding-agents` | EXISTS |

### CLI Commands (Verified in src/cli.ts)

| Command | Implemented | Works |
|---------|-------------|-------|
| `invoke <agent> <prompt>` | YES | Requires OPENAI_API_KEY |
| `scan <path>` | YES | Works offline |
| `report <projectId>` | YES | Requires hub API |
| `analytics [projectId]` | YES | Requires hub API |
| `generate-rules <projectId>` | YES | Requires hub API |
| `hooks install/uninstall/status` | YES | Works offline |
| `init` | YES | Works offline |
| `help` | YES | Works offline |
| `verify` | **NO** | Not implemented |

### API Endpoints Required on Client (From express-router.ts)

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/agents/health` | GET | Health check |
| `/api/agents/external/report` | POST | Receive agent reports |
| `/api/agents/reports` | GET | List reports |
| `/api/agents/monitor/analytics` | GET | View analytics |
| `/api/agents/guidelines/:projectId` | GET | Get project guidelines |
| `/api/agents/guidelines/generate` | POST | Force regenerate |
| `/api/agents/logs/ingest` | POST | Log ingestion |
| `/api/agents/logs` | GET | Query logs |
| `/api/agents/logs/stats` | GET | Log statistics |

---

## Part 2: Client Setup Requirements (From Real Client Feedback)

### Files Client Must Create/Modify

| File | Action | Content Source |
|------|--------|----------------|
| `.ai-agents.json` | AUTO (via init) | Generated by init |
| `scripts/ai-agents.sh` | AUTO (via init) | Generated by init |
| `shared/schema.ts` | MANUAL | Import from package |
| `server/storage.ts` | MANUAL | Implement IAgentStorage |
| `server/routes.ts` | MANUAL | Mount createAgentRouter |

### Manual Steps Required (Current State)

1. **Install package**: `npm install github:zambam/ai-coding-agents`
2. **Run init**: `npx ai-agents init --hub-url <url>`
3. **Add schema**: Copy import statements to shared/schema.ts
4. **Run migration**: `npm run db:push`
5. **Implement storage**: Create storage adapter (80+ lines)
6. **Mount router**: Add to server/routes.ts
7. **Test**: curl health endpoint

**Estimated Time**: 30-45 minutes

---

## Part 3: Gaps Identified + Fix Proposals

### Gap 1: Storage Implementation Not Auto-Generated

**Current**: `generateStorageScaffold()` exists in src/init.ts but init doesn't write it to a file.

**Evidence** (src/init.ts lines 136-228):
```typescript
export function generateStorageScaffold(orm: 'drizzle' | 'prisma' | 'none'): string {
  if (orm === 'drizzle') {
    return `...90 lines of working code...`;
  }
}
```

**FIX PROPOSAL**:

Add `--write-storage` flag to init command.

**Code Change** (src/init.ts - add after line 88):
```typescript
// After writing ai-agents.sh, optionally write storage scaffold
if (options.writeStorage && orm !== 'none') {
  const storageDir = path.join(projectPath, 'server');
  const storagePath = path.join(storageDir, 'agent-storage.ts');
  
  if (!fs.existsSync(storageDir)) {
    fs.mkdirSync(storageDir, { recursive: true });
  }
  
  const scaffold = generateStorageScaffold(orm);
  fs.writeFileSync(storagePath, scaffold.trim());
  result.filesCreated.push('server/agent-storage.ts');
}
```

**Code Change** (src/init.ts - update InitOptions interface):
```typescript
export interface InitOptions {
  framework: 'express' | 'fastify' | 'koa' | 'hono';
  orm: 'drizzle' | 'prisma' | 'none';
  projectPath: string;
  projectId?: string;
  hubUrl?: string;
  writeStorage?: boolean;  // NEW
}
```

**Code Change** (src/cli.ts - add flag parsing around line 750):
```typescript
// In init command parsing
let writeStorage = false;
for (let i = 1; i < args.length; i++) {
  if (args[i] === '--write-storage') {
    writeStorage = true;
  }
}
// Pass to runInit
```

---

### Gap 2: No Verify Command

**Current**: CLI has no way to test if setup is correct.

**FIX PROPOSAL**:

Add `verify` command that checks:
1. `.ai-agents.json` exists and is valid JSON
2. Hub URL is reachable (optional, skip if offline)
3. Required files exist

**Code Change** (src/cli.ts - add new function):
```typescript
interface VerifyOptions {
  offline?: boolean;
}

interface VerifyResult {
  passed: boolean;
  checks: Array<{ name: string; status: 'pass' | 'fail' | 'skip'; message: string }>;
}

export async function runVerify(options: VerifyOptions): Promise<CommandResult> {
  const checks: VerifyResult['checks'] = [];
  
  // Check 1: .ai-agents.json exists
  const configPath = path.join(process.cwd(), '.ai-agents.json');
  if (fs.existsSync(configPath)) {
    try {
      const config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
      checks.push({ 
        name: 'Config file', 
        status: 'pass', 
        message: `Found .ai-agents.json (project: ${config.projectId})` 
      });
    } catch {
      checks.push({ name: 'Config file', status: 'fail', message: 'Invalid JSON in .ai-agents.json' });
    }
  } else {
    checks.push({ name: 'Config file', status: 'fail', message: '.ai-agents.json not found. Run: npx ai-agents init' });
  }
  
  // Check 2: CLI wrapper exists
  const wrapperPath = path.join(process.cwd(), 'scripts', 'ai-agents.sh');
  if (fs.existsSync(wrapperPath)) {
    checks.push({ name: 'CLI wrapper', status: 'pass', message: 'scripts/ai-agents.sh exists' });
  } else {
    checks.push({ name: 'CLI wrapper', status: 'fail', message: 'scripts/ai-agents.sh not found' });
  }
  
  // Check 3: Hub reachable (skip if offline)
  if (!options.offline) {
    try {
      const config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
      const healthUrl = `${config.hubUrl}/api/agents/health`;
      const response = await fetch(healthUrl, { method: 'GET', signal: AbortSignal.timeout(5000) });
      if (response.ok) {
        checks.push({ name: 'Hub connection', status: 'pass', message: `Hub reachable at ${config.hubUrl}` });
      } else {
        checks.push({ name: 'Hub connection', status: 'fail', message: `Hub returned ${response.status}` });
      }
    } catch (error) {
      checks.push({ name: 'Hub connection', status: 'fail', message: `Hub unreachable: ${error}` });
    }
  } else {
    checks.push({ name: 'Hub connection', status: 'skip', message: 'Skipped (offline mode)' });
  }
  
  // Print results
  console.log('\n=== AI Agents Setup Verification ===\n');
  let allPassed = true;
  for (const check of checks) {
    const icon = check.status === 'pass' ? '[OK]' : check.status === 'fail' ? '[FAIL]' : '[SKIP]';
    console.log(`${icon} ${check.name}: ${check.message}`);
    if (check.status === 'fail') allPassed = false;
  }
  
  console.log(allPassed ? '\nAll checks passed!' : '\nSome checks failed. See above.');
  return { success: allPassed, exitCode: allPassed ? 0 : 1 };
}
```

**Code Change** (src/cli.ts - add to parseArgs switch):
```typescript
if (command === "verify") {
  const offline = args.includes("--offline");
  return await runVerify({ offline });
}
```

**Code Change** (src/cli.ts - update printHelp):
```typescript
  verify                     Verify setup is correct
  
Options for 'verify':
  --offline                  Skip hub connection check
```

---

### Gap 3: Import Path Aliases

**Current**: Package exports work but not documented in package.json exports field.

**FIX PROPOSAL**:

Add exports field to npm-package/package.json:

```json
{
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js",
      "require": "./dist/index.js"
    },
    "./express": {
      "types": "./dist/express-router.d.ts",
      "import": "./dist/express-router.js",
      "require": "./dist/express-router.js"
    },
    "./drizzle": {
      "types": "./dist/drizzle-schema.d.ts",
      "import": "./dist/drizzle-schema.js",
      "require": "./dist/drizzle-schema.js"
    }
  }
}
```

---

## Part 4: Sandbox Testing Strategy

### Method: `npm pack` + Temp Directory (Recommended)

Using `npm pack` simulates actual installation more accurately than `npm link`.

**Test Script** (`scripts/sandbox-test.sh`):
```bash
#!/bin/bash
set -e

echo "=== AI Agents Package Sandbox Test ==="
TIMESTAMP=$(date +%s)
SANDBOX_DIR="/tmp/ai-agents-sandbox-$TIMESTAMP"
PKG_DIR="$(pwd)/npm-package"
LOG_FILE="/tmp/ai-agents-sandbox-$TIMESTAMP.log"

# Cleanup function
cleanup() {
  echo "Cleaning up sandbox..."
  rm -rf "$SANDBOX_DIR"
}
trap cleanup EXIT

echo "[1/7] Building package..."
cd "$PKG_DIR"
npm run build:package 2>&1 | tee -a "$LOG_FILE"

echo "[2/7] Packing package..."
npm pack 2>&1 | tee -a "$LOG_FILE"
PKG_TGZ=$(ls -t *.tgz | head -1)
echo "Created: $PKG_TGZ" | tee -a "$LOG_FILE"

echo "[3/7] Creating sandbox project..."
mkdir -p "$SANDBOX_DIR"
cd "$SANDBOX_DIR"
npm init -y 2>&1 | tee -a "$LOG_FILE"

echo "[4/7] Installing package from tarball..."
npm install "$PKG_DIR/$PKG_TGZ" 2>&1 | tee -a "$LOG_FILE"

echo "[5/7] Testing CLI help..."
npx ai-agents help 2>&1 | tee -a "$LOG_FILE"

echo "[6/7] Testing init command..."
npx ai-agents init --framework express --orm drizzle --hub-url http://localhost:5000 2>&1 | tee -a "$LOG_FILE"

echo "[7/7] Verifying created files..."
if [ -f ".ai-agents.json" ]; then
  echo "[OK] .ai-agents.json created" | tee -a "$LOG_FILE"
  cat .ai-agents.json | tee -a "$LOG_FILE"
else
  echo "[FAIL] .ai-agents.json not found" | tee -a "$LOG_FILE"
  exit 1
fi

if [ -f "scripts/ai-agents.sh" ]; then
  echo "[OK] scripts/ai-agents.sh created" | tee -a "$LOG_FILE"
else
  echo "[FAIL] scripts/ai-agents.sh not found" | tee -a "$LOG_FILE"
  exit 1
fi

echo ""
echo "=== SANDBOX TEST PASSED ==="
echo "Log file: $LOG_FILE"

# Cleanup tarball
rm -f "$PKG_DIR/$PKG_TGZ"
```

### Verification Checks (Logged)

| Check | Command | Expected |
|-------|---------|----------|
| Package builds | `npm run build:package` | Exit 0, dist/ populated |
| Package packs | `npm pack` | Creates .tgz file |
| Help works | `npx ai-agents help` | Shows usage |
| Init works | `npx ai-agents init` | Creates .ai-agents.json |
| Hooks status | `npx ai-agents hooks status` | Shows hook status |
| Scan works | `npx ai-agents scan .` | Runs without error |
| Exports resolve | Node require test | All exports accessible |

---

## Part 5: Phase A - Documentation (DONE)

| Task | File | Status |
|------|------|--------|
| A1 | `docs/QUICKSTART.md` | DONE |
| A2 | `npm-package/README.md` | DONE - added link |
| A3 | Cleanup old proposals | PENDING |

---

## Part 6: Phase B - CLI Enhancements

### B1: Add `--write-storage` Flag to Init

**Files to Modify**:
- `src/init.ts` (add writeStorage option + file writing logic)
- `src/cli.ts` (parse --write-storage flag, pass to initProject)

**Implementation Steps**:

1. Update InitOptions interface in `src/init.ts`:
```typescript
export interface InitOptions {
  framework: 'express' | 'fastify' | 'koa' | 'hono';
  orm: 'drizzle' | 'prisma' | 'none';
  projectPath: string;
  projectId?: string;
  hubUrl?: string;
  writeStorage?: boolean;  // ADD THIS
}
```

2. Add file writing logic in `initProject()` after line 88 in `src/init.ts`:
```typescript
// Write storage scaffold if requested
if (options.writeStorage && orm !== 'none') {
  const serverDir = path.join(projectPath, 'server');
  const storagePath = path.join(serverDir, 'agent-storage.ts');
  
  if (!fs.existsSync(serverDir)) {
    fs.mkdirSync(serverDir, { recursive: true });
  }
  
  const scaffoldContent = generateStorageScaffold(orm);
  fs.writeFileSync(storagePath, scaffoldContent.trim());
  result.filesCreated.push('server/agent-storage.ts');
  
  result.instructions.push('\nStorage adapter created at server/agent-storage.ts');
  result.instructions.push('Update the import path for your db connection if needed.');
}
```

3. Update CLI parsing in `src/cli.ts` around line 750:
```typescript
// In init command section
const initOptions: InitProjectOptions = {
  framework: 'express',
  orm: 'drizzle', 
  projectPath: process.cwd(),
  writeStorage: false,  // ADD
};

for (let i = 1; i < args.length; i++) {
  const arg = args[i];
  if (arg === '--write-storage') {
    initOptions.writeStorage = true;
  }
  // ... existing flag parsing
}
```

4. Update help text in `printHelp()`:
```typescript
Options for 'init':
  --framework <type>         Framework: express (default), fastify, koa, hono
  --orm <type>               ORM: drizzle (default), prisma, none
  --path <dir>               Project path (default: current directory)
  --project-id <id>          Project identifier (default: directory name)
  --hub-url <url>            Hub server URL (default: http://localhost:5000)
  --write-storage            Generate server/agent-storage.ts scaffold  # ADD
```

**Test Command**:
```bash
npx ai-agents init --framework express --orm drizzle --hub-url http://localhost:5000 --write-storage
ls -la server/agent-storage.ts
```

---

### B2: Add `verify` Command

**Files to Modify**:
- `src/cli.ts` (add runVerify function + command parsing)

**Implementation** (add to src/cli.ts after line 510):
```typescript
interface VerifyOptions {
  offline?: boolean;
}

export async function runVerify(options: VerifyOptions): Promise<CommandResult> {
  const fs = await import("fs");
  const path = await import("path");
  
  const checks: Array<{ name: string; status: 'pass' | 'fail' | 'skip'; message: string }> = [];
  const configPath = path.join(process.cwd(), '.ai-agents.json');
  let config: { projectId?: string; hubUrl?: string } | null = null;
  
  // Check 1: Config file exists and is valid
  if (fs.existsSync(configPath)) {
    try {
      config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
      checks.push({ 
        name: 'Config file', 
        status: 'pass', 
        message: `.ai-agents.json valid (project: ${config?.projectId || 'unknown'})` 
      });
    } catch {
      checks.push({ name: 'Config file', status: 'fail', message: 'Invalid JSON in .ai-agents.json' });
    }
  } else {
    checks.push({ name: 'Config file', status: 'fail', message: '.ai-agents.json not found. Run: npx ai-agents init' });
  }
  
  // Check 2: CLI wrapper script
  const wrapperPath = path.join(process.cwd(), 'scripts', 'ai-agents.sh');
  if (fs.existsSync(wrapperPath)) {
    checks.push({ name: 'CLI wrapper', status: 'pass', message: 'scripts/ai-agents.sh exists' });
  } else {
    checks.push({ name: 'CLI wrapper', status: 'fail', message: 'scripts/ai-agents.sh not found' });
  }
  
  // Check 3: Storage file (optional)
  const storagePath = path.join(process.cwd(), 'server', 'agent-storage.ts');
  if (fs.existsSync(storagePath)) {
    checks.push({ name: 'Storage adapter', status: 'pass', message: 'server/agent-storage.ts exists' });
  } else {
    checks.push({ name: 'Storage adapter', status: 'skip', message: 'server/agent-storage.ts not found (optional)' });
  }
  
  // Check 4: Hub connectivity (unless offline)
  if (!options.offline && config?.hubUrl) {
    try {
      const healthUrl = `${config.hubUrl}/api/agents/health`;
      const response = await fetch(healthUrl, { 
        method: 'GET', 
        signal: AbortSignal.timeout(5000) 
      });
      if (response.ok) {
        const data = await response.json() as { status?: string };
        checks.push({ 
          name: 'Hub connection', 
          status: 'pass', 
          message: `Hub reachable at ${config.hubUrl} (status: ${data.status || 'ok'})` 
        });
      } else {
        checks.push({ name: 'Hub connection', status: 'fail', message: `Hub returned HTTP ${response.status}` });
      }
    } catch (error) {
      const msg = error instanceof Error ? error.message : String(error);
      checks.push({ name: 'Hub connection', status: 'fail', message: `Hub unreachable: ${msg}` });
    }
  } else if (options.offline) {
    checks.push({ name: 'Hub connection', status: 'skip', message: 'Skipped (--offline mode)' });
  } else {
    checks.push({ name: 'Hub connection', status: 'skip', message: 'No hubUrl in config' });
  }
  
  // Print results
  console.log('\n=== AI Agents Setup Verification ===\n');
  let allPassed = true;
  for (const check of checks) {
    const icon = check.status === 'pass' ? '[OK]  ' : check.status === 'fail' ? '[FAIL]' : '[SKIP]';
    console.log(`${icon} ${check.name}: ${check.message}`);
    if (check.status === 'fail') allPassed = false;
  }
  
  const failCount = checks.filter(c => c.status === 'fail').length;
  console.log(allPassed ? '\nAll checks passed!' : `\n${failCount} check(s) failed.`);
  
  return { success: allPassed, exitCode: allPassed ? 0 : 1 };
}
```

**Add to parseArgs switch** (around line 637):
```typescript
if (command === "verify") {
  const offline = args.includes("--offline");
  return await runVerify({ offline });
}
```

**Update printHelp**:
```typescript
Commands:
  ...
  verify                     Verify project setup is correct
  
Options for 'verify':
  --offline                  Skip hub connection check
```

**Test Commands**:
```bash
# Without hub
npx ai-agents verify --offline

# With hub running
npx ai-agents verify
```

---

## Part 7: Phase C - Package Configuration

### C1: Add Exports Field to package.json

**File**: `npm-package/package.json`

**Add after "main" field**:
```json
{
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js",
      "require": "./dist/index.js"
    },
    "./express": {
      "types": "./dist/express-router.d.ts",
      "import": "./dist/express-router.js",
      "require": "./dist/express-router.js"
    },
    "./drizzle": {
      "types": "./dist/drizzle-schema.d.ts",
      "import": "./dist/drizzle-schema.js",
      "require": "./dist/drizzle-schema.js"
    },
    "./init": {
      "types": "./dist/init.d.ts",
      "import": "./dist/init.js",
      "require": "./dist/init.js"
    }
  },
  "bin": {
    "ai-agents": "./dist/cli.js"
  }
}
```

### C2: Verify Dependencies

Check that all runtime dependencies are in `dependencies` (not `devDependencies`):

**Required in dependencies**:
- `drizzle-orm` (for schema exports)
- `uuid` (for report IDs)
- `pino` (for logging)

### C3: Verify .npmignore

**File**: `npm-package/.npmignore`

Should include:
```
src/
*.ts
!dist/**/*.d.ts
tsconfig.json
tests/
__tests__/
*.test.ts
*.spec.ts
.git/
node_modules/
```

---

## Part 8: Automated Sandbox Testing (Simulated Environment)

### Test Runner Script

**File**: `scripts/sandbox-test.ts`

```typescript
/**
 * Sandbox Test Runner
 * 
 * Simulates client installation in temp directory.
 * Logs all steps for verification.
 * 
 * Usage: npx tsx scripts/sandbox-test.ts
 */

import * as fs from 'fs';
import * as path from 'path';
import { execSync } from 'child_process';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  output: string;
  error?: string;
}

const SANDBOX_DIR = `/tmp/ai-agents-sandbox-${Date.now()}`;
const LOG_FILE = `${SANDBOX_DIR}/test.log`;
const RESULTS: TestResult[] = [];

function log(msg: string) {
  const timestamp = new Date().toISOString();
  const line = `[${timestamp}] ${msg}`;
  console.log(line);
  fs.appendFileSync(LOG_FILE, line + '\n');
}

function runTest(name: string, fn: () => string): TestResult {
  const start = Date.now();
  try {
    const output = fn();
    const result: TestResult = {
      name,
      passed: true,
      duration: Date.now() - start,
      output
    };
    RESULTS.push(result);
    log(`[PASS] ${name} (${result.duration}ms)`);
    return result;
  } catch (error) {
    const result: TestResult = {
      name,
      passed: false,
      duration: Date.now() - start,
      output: '',
      error: error instanceof Error ? error.message : String(error)
    };
    RESULTS.push(result);
    log(`[FAIL] ${name}: ${result.error}`);
    return result;
  }
}

function exec(cmd: string, cwd?: string): string {
  return execSync(cmd, { 
    cwd: cwd || process.cwd(),
    encoding: 'utf-8',
    stdio: ['pipe', 'pipe', 'pipe']
  });
}

async function main() {
  const pkgDir = path.resolve(__dirname, '..', 'npm-package');
  
  // Setup
  log('=== AI Agents Sandbox Test ===');
  log(`Package dir: ${pkgDir}`);
  log(`Sandbox dir: ${SANDBOX_DIR}`);
  
  fs.mkdirSync(SANDBOX_DIR, { recursive: true });
  
  // Test 1: Build package
  runTest('Build package', () => {
    return exec('npm run build:package', pkgDir);
  });
  
  // Test 2: Create tarball
  let tgzPath = '';
  runTest('Pack package', () => {
    exec('npm pack', pkgDir);
    const files = fs.readdirSync(pkgDir).filter(f => f.endsWith('.tgz'));
    if (files.length === 0) throw new Error('No .tgz file created');
    tgzPath = path.join(pkgDir, files[files.length - 1]);
    return `Created: ${tgzPath}`;
  });
  
  // Test 3: Init sandbox project
  runTest('Init sandbox project', () => {
    exec('npm init -y', SANDBOX_DIR);
    return fs.readFileSync(path.join(SANDBOX_DIR, 'package.json'), 'utf-8');
  });
  
  // Test 4: Install from tarball
  runTest('Install package', () => {
    return exec(`npm install ${tgzPath}`, SANDBOX_DIR);
  });
  
  // Test 5: CLI help works
  runTest('CLI help', () => {
    return exec('npx ai-agents help', SANDBOX_DIR);
  });
  
  // Test 6: Init creates config
  runTest('Init command', () => {
    return exec('npx ai-agents init --framework express --orm drizzle --hub-url http://localhost:5000', SANDBOX_DIR);
  });
  
  // Test 7: Config file exists
  runTest('Config file created', () => {
    const configPath = path.join(SANDBOX_DIR, '.ai-agents.json');
    if (!fs.existsSync(configPath)) throw new Error('File not found');
    return fs.readFileSync(configPath, 'utf-8');
  });
  
  // Test 8: Wrapper script exists
  runTest('Wrapper script created', () => {
    const scriptPath = path.join(SANDBOX_DIR, 'scripts', 'ai-agents.sh');
    if (!fs.existsSync(scriptPath)) throw new Error('File not found');
    return fs.readFileSync(scriptPath, 'utf-8');
  });
  
  // Test 9: Hooks status works
  runTest('Hooks status', () => {
    // Init git repo first
    exec('git init', SANDBOX_DIR);
    return exec('npx ai-agents hooks status', SANDBOX_DIR);
  });
  
  // Test 10: Exports resolve
  runTest('Export resolution', () => {
    const testScript = `
      const pkg = require('ai-coding-agents');
      const express = require('ai-coding-agents/express');
      const drizzle = require('ai-coding-agents/drizzle');
      console.log('Main exports:', Object.keys(pkg).length);
      console.log('Express exports:', Object.keys(express).length);
      console.log('Drizzle exports:', Object.keys(drizzle).length);
      if (!express.createAgentRouter) throw new Error('Missing createAgentRouter');
      if (!drizzle.agentReportsTable) throw new Error('Missing agentReportsTable');
    `;
    fs.writeFileSync(path.join(SANDBOX_DIR, 'test-exports.js'), testScript);
    return exec('node test-exports.js', SANDBOX_DIR);
  });
  
  // Summary
  log('\n=== Test Summary ===');
  const passed = RESULTS.filter(r => r.passed).length;
  const failed = RESULTS.filter(r => !r.passed).length;
  log(`Passed: ${passed}/${RESULTS.length}`);
  log(`Failed: ${failed}/${RESULTS.length}`);
  
  if (failed > 0) {
    log('\nFailed tests:');
    RESULTS.filter(r => !r.passed).forEach(r => {
      log(`  - ${r.name}: ${r.error}`);
    });
  }
  
  // Write full results
  const resultsPath = path.join(SANDBOX_DIR, 'results.json');
  fs.writeFileSync(resultsPath, JSON.stringify(RESULTS, null, 2));
  log(`\nFull results: ${resultsPath}`);
  log(`Full log: ${LOG_FILE}`);
  
  // Cleanup tarball
  if (tgzPath && fs.existsSync(tgzPath)) {
    fs.unlinkSync(tgzPath);
  }
  
  // Exit with appropriate code
  process.exit(failed > 0 ? 1 : 0);
}

main().catch(err => {
  console.error('Fatal error:', err);
  process.exit(1);
});
```

### Running Sandbox Tests

```bash
# From project root
npx tsx scripts/sandbox-test.ts

# View results
cat /tmp/ai-agents-sandbox-*/test.log
cat /tmp/ai-agents-sandbox-*/results.json
```

### What Gets Logged

| Item | Location |
|------|----------|
| Test results (pass/fail) | Console + test.log |
| Command output | test.log |
| Timing per test | results.json |
| Error messages | results.json |
| Created files content | test.log |

---

## Part 9: Environment Variable Reference

### Client Must Set

| Variable | Required | Default | Purpose |
|----------|----------|---------|---------|
| `AI_AGENTS_API_URL` | For CLI | `http://localhost:5000` | Hub server URL |
| `AI_AGENTS_PROJECT_ID` | Optional | Directory name | Project identifier |
| `AI_AGENTS_LOG_HTTP` | For logging | - | HTTP log endpoint |
| `OPENAI_API_KEY` | For invoke | - | Agent invocations |

### Auto-Set by Init

| Variable | Set In | Value |
|----------|--------|-------|
| `AI_AGENTS_API_URL` | scripts/ai-agents.sh | From --hub-url |
| `AI_AGENTS_PROJECT_ID` | scripts/ai-agents.sh | From --project-id or dirname |
| `AI_AGENTS_LOG_HTTP` | scripts/ai-agents.sh | `{hub-url}/api/agents/logs/ingest` |

---

## Part 10: Approval Checklist

### Phase A (DONE)

- [x] QUICKSTART.md created with copy-paste blocks
- [x] README.md updated with quickstart link
- [ ] Delete old/contradicting proposal files

### Phase B (Implementation Required)

- [ ] B1: Add `--write-storage` flag to init
  - [ ] Update InitOptions interface
  - [ ] Add file writing logic
  - [ ] Update CLI flag parsing
  - [ ] Update help text
- [ ] B2: Add `verify` command
  - [ ] Implement runVerify function
  - [ ] Add to parseArgs switch
  - [ ] Update help text
- [ ] Test both commands in sandbox

### Phase C (Configuration Required)

- [ ] C1: Add exports field to package.json
- [ ] C2: Verify runtime dependencies
- [ ] C3: Verify .npmignore

### Post-Implementation Testing

- [ ] Run `scripts/sandbox-test.ts`
- [ ] Verify all 10 tests pass
- [ ] Review test.log for issues
- [ ] Clean up tarball artifacts

---

## Appendix: Files to Delete

Outdated/contradicting proposal files:

```
docs/INSTALL_IMPROVEMENT_PROPOSAL.md  # Has fictional verify command (now real)
docs/NPM_PACKAGE_PREP_PROPOSAL.md     # Review for conflicts
```

---

**Status**: AWAITING REVIEW

Upon approval:
1. Implement Phase B (CLI enhancements)
2. Implement Phase C (package configuration)
3. Create sandbox-test.ts
4. Run full sandbox test with logging
5. Clean up old proposals
